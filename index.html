<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        max-width: 700px;
       }
    </style>
  </head>
  <body>
    <h3>My Map</h3>
    <select id='select_types'>

    </select>
    <br/>
    <br/>
    <div id="map"></div>
    <script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCW4JydH6A5H6AGhyGGt5Lr2br3aHdWdxM",
    authDomain: "shining-heat-317.firebaseapp.com",
    databaseURL: "https://shining-heat-317.firebaseio.com",
    storageBucket: "shining-heat-317.appspot.com",
    messagingSenderId: "752402622831"
  };
  firebase.initializeApp(config);
</script>
    <script>
    var apiKey = "AIzaSyCs3DFzngMkLn-9Io_WPh5IcdEFL5jRTlk";
    var placeTypes;
    var myLoc;
    var map;
    var currentMarkers = [];
    var infoWindow; 

var setMapOnMarkers = function(currentMap){
  for(var i = 0; i< currentMarkers.length; i++){
    currentMarkers[i].setMap(currentMap);
  }
}
var deleteCurrentMarkers = function(){
  setMapOnMarkers(null);
  currentMarkers = [];
}
var changeSelectTypes = function(e){
console.log(this.value);
        getNearbyPlaces();

};
  var ac = firebase.database().ref("ac");
  ac.on("child_added", function(snap){
placeTypes = snap.val();
var selectTypes = document.getElementById("select_types");

selectTypes.addEventListener("change", changeSelectTypes, false);
selectTypes.textContent = "";
for(var key in placeTypes){
  if(placeTypes.hasOwnProperty(key)){
    var option = document.createElement("option");
    option.textContent = placeTypes[key].split(",")[0];
    option.setAttribute("value", key);
    selectTypes.appendChild(option);
  }
}});


    var setMyLocation = function(){
 // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            myLoc = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            if(map){
            map.setCenter(myLoc);
            map.setZoom(15);
            }
            getNearbyPlaces();
            infoWindow = new google.maps.InfoWindow({map: map});

            

          }, function() {
            // handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          // handleLocationError(false, infoWindow, map.getCenter());
        }
}
var getNearbyPlaces = function(){
  if(!map || !myLoc) return;
        var myLatLng = new google.maps.LatLng(myLoc.lat,myLoc.lng);
var type = document.getElementById("select_types").value;
  var request = {
    location: myLatLng,
    radius: '500',
    types: [type]
  };

  service = new google.maps.places.PlacesService(map);
  service.nearbySearch(request, callback);
}
      function callback(results, status) {
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    deleteCurrentMarkers();
    for (var i = 0; i < results.length; i++) {
      var place = results[i];
      createMarker(results[i]);
    }
  }
      }
            var createMarker = function(place){
        console.log(place);
        var lat = place.geometry.location.lat();
        var lng = place.geometry.location.lng();
        var pos = {
              lat: lat,
              lng: lng
            };
        var marker = new google.maps.Marker({
          position: pos,
          map: map,
          title: place.name
        });
        marker.addListener("click", function(){
          infoWindow.setContent(place.name);
          infoWindow.open(map, marker);

        });
        currentMarkers.push(marker);
      }
      function initMap() {
        var defaultLoc = {lat: -25.363, lng: 131.044};
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 4,
          center: defaultLoc
        });
        setMyLocation();
        

       

      };
      // function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      //   infoWindow.setPosition(pos);
      //   infoWindow.setContent(browserHasGeolocation ?
      //                         'Error: The Geolocation service failed.' :
      //                         'Error: Your browser doesn\'t support geolocation.');
      // };

var getPlaceById = function(id){
  var url = "https://maps.googleapis.com/maps/api/place/details/json?placeid="+id+"&key="+apiKey+"";
  
}

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCs3DFzngMkLn-9Io_WPh5IcdEFL5jRTlk&libraries=places&callback=initMap">
    </script>
    

  </body>
</html>